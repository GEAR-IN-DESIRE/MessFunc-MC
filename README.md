# MessFunc-MC

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)

## server 部分

## 项目组成

1. 由 GEAR_IN_DESIRE 原创实现的多线程架构
2. 由 Pumpkin 重构而来的具体实现    

## 项目简介

    全新的异步多线程负载均衡架构驱动的 Minecraft 服务器实现

    无锁管理 99%+ 的 Chunk, 多线程性能, 单线程复杂度, 完全避免死锁

    同时保证 极致性能 (不为一个 if 妥协) + 极致代码优雅 + 极致思想统一
    

## 负载均衡

    相互依赖的 Chunk 将会被调度在同一线程, 完成首次调度后, 后续读写完全无同步机制.
    如果线程负载过高, 新 Chunk 会被存放到全局并单独加锁. 对于正确的应用场景, 仅有 1%- 的 Chunk 会被调到到全局加锁
    不同于传统架构, 仅在必要时使用更多线程, 任务较轻时尽可能减少线程甚至单线程以降低调度开销.
    对比传统架构, 在仅单线程执行任务时, 也会对完全没必要的数据加锁, 但在这里, 完全0同步开销.

## 思想统一

一              代码即插件系统 + 代码即配置文件 + 代码即命令系统

1. 不提供 插件API, 而是使用 Rust 条件编译实现替代
    - 直接集成实现插件功能, 拥有插件动态性的同时, 没有插件的抽象性能开销

2. 不使用传统配置文件
    - 根据 debug + release 编译模式进行条件编译, 在 debug 模式下保持足够的动态性, 在 release 模式下保持极致的性能

3. 改进实现命令系统 + 移除命令权限系统
    - 仅实现控制台执行命令, 命令直接使用 Rust. 也就是玩家无法再执行命令, 不再需要命令权限系统


二                               网络转发

1. 由 多线程 + 物理机集群操作系统 共同替代 转发服务器 的分布式意义, 因此也不会对转发服务器进行兼容

## 回调修改

    一部分十分轻量的写任务将被回调到主线程在所有 Chunk线程 结束时统一修改
    如世界规则/天气这样的全局状态 使得多线程在只读它们的时刻可以做到甚至无需读写锁

## 异步管理

    统一使用 async_wait() 驱动需要等待结果的的异步代码, 在任务挂起时取下一个 Chunk tick + 堆内存回收 + 日志写入 + 数据包发送 + 数据结构缩容 + 其他非及时任务

## 所有权管理

    所有权统一管理在 Chunk; 全局以 SyncPos 索引到 Chunk 获取可变借用
    如获取 Player, 全局存储`Players: HashMap<Uuid, SyncEntityPos>` 通过 UUID 得到 SyncEntityPos 得到 Chunk 得到 Player / &mut Player

## 缓存友好

    相互依赖的 Chunk 总是保持在相同线程, 线程本地 Chunk 过多将被调度到全局, 使得缓存命中率极高

## 特性复刻

1. 复刻绝大多数原版特性, 不复刻与其他目标冲突的不重要特性
    如: 修改世界规则将不再立即完成, 而是在 tick 末尾